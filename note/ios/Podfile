# Uncomment this line to define a global platform for your project
platform :ios, '13.0'

# CocoaPods analytics sends network stats synchronously affecting flutter build latency.
ENV['COCOAPODS_DISABLE_STATS'] = 'true'

project 'Runner', {
  'Debug' => :debug,
  'Profile' => :release,
  'Release' => :release,
}

# Hàm này dùng để lấy đường dẫn FLUTTER_ROOT từ file Generated.xcconfig
def flutter_root
  generated_xcode_build_settings_path = File.expand_path(File.join('..', 'Flutter', 'Generated.xcconfig'), __FILE__)
  unless File.exist?(generated_xcode_build_settings_path)
    raise "#{generated_xcode_build_settings_path} must exist. If you're running pod install manually, make sure flutter pub get is executed first"
  end
  File.foreach(generated_xcode_build_settings_path) do |line|
    matches = line.match(/FLUTTER_ROOT\=(.*)/)
    return matches[1].strip if matches
  end
  raise "FLUTTER_ROOT not found in #{generated_xcode_build_settings_path}. Try deleting Generated.xcconfig, then run flutter pub get"
end

# Load file podhelper.rb từ Flutter SDK (thường nằm trong packages/flutter_tools/bin)
require File.expand_path(File.join('packages', 'flutter_tools', 'bin', 'podhelper'), flutter_root)

# Cài đặt Podfile cho iOS của Flutter
flutter_ios_podfile_setup

target 'Runner' do
  use_frameworks!
  use_modular_headers!

  # Cài đặt tất cả các pods cần thiết cho Flutter
  flutter_install_all_ios_pods File.dirname(File.realpath(__FILE__))
end

post_install do |installer|
  installer.pods_project.targets.each do |target|
    flutter_additional_ios_build_settings(target)
    target.build_configurations.each do |config|
      config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] ||= '13.0'
      
      # Fix for Xcode 15 and later - disable code signing
      config.build_settings['CODE_SIGNING_ALLOWED'] = 'NO'
      config.build_settings['CODE_SIGNING_REQUIRED'] = 'NO'
      
      # Disable bitcode as it's deprecated by Apple
      config.build_settings['ENABLE_BITCODE'] = 'NO'
      
      # Ensure proper architectures for both device and simulator
      config.build_settings['ONLY_ACTIVE_ARCH'] = 'NO'
      
      # Fix for ARM64 architecture issues
      config.build_settings['EXCLUDED_ARCHS[sdk=iphonesimulator*]'] = 'arm64'
      
      # Handle Swift version issues - critical for connectivity_plus
      config.build_settings['SWIFT_VERSION'] = '5.0'
      
      # Fix Swift standard libraries handling
      config.build_settings['ALWAYS_EMBED_SWIFT_STANDARD_LIBRARIES'] = 'YES'
      
      # Exclude warnings that might interrupt CI build process
      config.build_settings['GCC_WARN_INHIBIT_ALL_WARNINGS'] = 'YES'
      config.build_settings['SWIFT_SUPPRESS_WARNINGS'] = 'YES'
      
      # Add support for older iOS versions
      config.build_settings['SWIFT_OPTIMIZATION_LEVEL'] = '-Onone'
      
      # Fix for Swift ABI stability issues on older iOS versions
      if target.name.include?('connectivity_plus')
        config.build_settings['BUILD_LIBRARY_FOR_DISTRIBUTION'] = 'YES'
      end
      
      # Xử lý đặc biệt cho plugin permission_handler_apple
      if target.name == 'permission_handler_apple'
        create_privacy_manifest(installer, target)
      end
    end
  end
  
  # Fix permissions issue
  installer.pods_project.build_configurations.each do |config|
    config.build_settings["EXCLUDED_ARCHS[sdk=iphonesimulator*]"] = "arm64"
    # Fix Swift standard libraries for release builds
    config.build_settings['ALWAYS_EMBED_SWIFT_STANDARD_LIBRARIES'] = 'YES'
  end
end

# Thêm hàm tạo privacy manifest cho permission_handler_apple
def create_privacy_manifest(installer, target)
  # Đảm bảo target là permission_handler_apple
  return unless target.name == 'permission_handler_apple'
  
  # Thêm script phase để tạo thư mục và file cần thiết
  phase = target.shell_script_build_phases.find { |phase| phase.name == 'Create Privacy Manifest' }
  if phase.nil?
    phase = target.new_shell_script_build_phase('Create Privacy Manifest')
    phase.shell_script = <<-SCRIPT
    mkdir -p "${BUILT_PRODUCTS_DIR}/permission_handler_apple/permission_handler_apple_privacy.bundle"
    touch "${BUILT_PRODUCTS_DIR}/permission_handler_apple/permission_handler_apple_privacy.bundle/permission_handler_apple_privacy"
    SCRIPT
  end
end
